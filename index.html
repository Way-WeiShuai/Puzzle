<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾å¤§å¸ˆ v5.1 - é€»è¾‘ä¿®å¤ç‰ˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #0f0f1e; --gold: #f1c40f; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; }
        
        #user-bar { width: 100%; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .avatar { width: 34px; height: 34px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .screen { display: none; width: 100%; height: calc(100vh - 55px); overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; }
        
        #level-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .card { background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; position: relative; }
        .card:active { transform: scale(0.95); }
        .card-img { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; background: #252545; color: rgba(255,255,255,0.2); font-weight: bold; position: relative; }
        .card-img img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; }
        .card-status { padding: 6px; text-align: center; font-size: 0.7rem; background: rgba(0,0,0,0.4); color: #aaa; }
        .card.done .card-status { color: var(--gold); }
        .card.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        #board-container { position: relative; margin: 0 auto; background: #000; border-radius: 8px; overflow: visible; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .piece { position: absolute; box-sizing: border-box; border: 0.5px solid rgba(255,255,255,0.15); background-repeat: no-repeat; z-index: 10; touch-action: none; }
        #victory-img { position: absolute; inset:0; width:100%; height:100%; opacity:0; z-index: 1000; pointer-events: none; transition: 1.2s cubic-bezier(0.4, 0, 0.2, 1); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--primary); color: white; }
        
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--primary); color: white; padding: 15px 40px; border-radius: 40px; font-size: 1.5rem; font-weight: bold; z-index: 9999; display: none; }
    </style>
</head>
<body>

    <div id="user-bar">
        <div style="display:flex; align-items:center; gap:10px">
            <div class="avatar" id="u-init">?</div>
            <div>
                <div id="u-name" style="font-size:0.85rem; font-weight:bold">åŠ è½½ä¸­...</div>
                <div id="u-lv" style="font-size:0.7rem; opacity:0.6">Lv.0</div>
            </div>
        </div>
        <button class="btn" style="background:var(--gold); color:#000; font-size:0.8rem" onclick="window.toggleRank(true)">ğŸ† æ’è¡Œæ¦œ</button>
    </div>

    <div id="menu-screen" class="screen active">
        <h2 style="text-align:center; margin-bottom:20px;">ğŸ§© æ‹¼å›¾å¤§æœ¬è¥</h2>
        <div id="level-grid"></div>
    </div>

    <div id="game-screen" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <button class="btn" style="background:#333" onclick="window.exitGame()">â† è¿”å›</button>
            <h3 id="cur-lv-text" style="margin:0">Level 1</h3>
            <div style="width:50px"></div>
        </div>
        <div id="board-container">
            <div id="puzzle-board"></div>
            <img id="victory-img" src="">
        </div>
    </div>

    <div id="rank-modal" class="overlay">
        <div style="background:#1a1a2e; padding:25px; border-radius:15px; width:85%; max-width:320px; border:1px solid var(--gold)">
            <h3 style="color:var(--gold); text-align:center; margin-top:0">ğŸ† å…¨çƒè‹±é›„æ¦œ</h3>
            <div id="rank-list" style="max-height:300px; overflow-y:auto; font-size:0.9rem"></div>
            <button class="btn" style="width:100%; margin-top:20px" onclick="window.toggleRank(false)">å…³é—­</button>
        </div>
    </div>

    <div id="toast">Level 1</div>

    <script>
        // --- 1. å…¨å±€é…ç½®ä¸å®‰å…¨åˆå§‹åŒ– ---
        const CONFIG = {
            URL: 'https://afdnvaysvwdmbnxklogt.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE'
        };

        let _db = null;
        try {
            if (window.supabase) {
                _db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
            }
        } catch(e) { console.error("DB Error", e); }

        let completed = JSON.parse(localStorage.getItem('puz_save_v51') || '[]');
        let currentL = 1, pieces = [], isWin = false;
        let boardW = Math.min(window.innerWidth - 40, 480);

        // --- 2. æ ¸å¿ƒå‡½æ•°ï¼ˆæŒ‚è½½åˆ° window ç¡®ä¿ onclick èƒ½æ‰¾åˆ°ï¼‰ ---
        window.renderMenu = function() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            for(let i=1; i<=15; i++) {
                const isDone = completed.includes(i);
                const isLocked = i > 1 && !completed.includes(i-1);
                
                const card = document.createElement('div');
                card.className = `card ${isLocked ? 'locked' : ''} ${isDone ? 'done' : ''}`;
                card.innerHTML = `
                    <div class="card-img">${i}
                        <img src="${i}.jpg" onload="this.style.opacity=1" onerror="this.style.display='none'">
                    </div>
                    <div class="card-status">${isDone ? 'âœ… å·²è¾¾æˆ' : (isLocked ? 'ğŸ”’ æœªè§£é”' : 'ğŸ”¥ æŒ‘æˆ˜ä¸­')}</div>
                `;
                if(!isLocked) card.onclick = () => window.startLevel(i);
                grid.appendChild(card);
            }
            document.getElementById('u-lv').innerText = `Lv.${completed.length}`;
            document.getElementById('u-name').innerText = localStorage.getItem('puz_nick') || 'åŒ¿åç©å®¶';
            document.getElementById('u-init').innerText = (localStorage.getItem('puz_nick') || 'P')[0];
        };

        window.startLevel = function(id) {
            currentL = id; isWin = false;
            
            // å…³å¡æç¤º
            const t = document.getElementById('toast');
            t.innerText = `Level ${id}`; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 1200);

            const board = document.getElementById('puzzle-board');
            const vImg = document.getElementById('victory-img');
            board.innerHTML = ''; 
            vImg.src = `${id}.jpg`; vImg.style.opacity = '0'; vImg.style.transform = 'scale(1)';

            // åˆå§‹åŒ–æ£‹ç›˜
            const rows = 3, cols = 3;
            const img = new Image();
            img.src = `${id}.jpg`;
            img.onload = () => setup(img.width, img.height);
            img.onerror = () => setup(400, 400); // å›¾ç‰‡åŠ è½½å¤±è´¥é»˜è®¤ 1:1

            function setup(iw, ih) {
                const ratio = ih / iw;
                const h = boardW * ratio;
                const container = document.getElementById('board-container');
                container.style.width = boardW + 'px'; container.style.height = h + 'px';

                const pw = boardW / cols, ph = h / rows;
                pieces = [];
                for(let r=0; r<rows; r++) {
                    for(let c=0; c<cols; c++) {
                        const pid = r * cols + c;
                        const p = { id: pid, x: Math.random()*(boardW-pw), y: Math.random()*(h-ph), tx: c*pw, ty: r*ph, group: [pid] };
                        pieces.push(p);

                        const div = document.createElement('div');
                        div.className = 'piece'; div.id = `pc-${pid}`;
                        div.style.width = pw+'px'; div.style.height = ph+'px';
                        div.style.backgroundImage = `url(${id}.jpg)`;
                        div.style.backgroundColor = '#1a1a2e'; // æ²¡å›¾æ—¶çš„åº•è‰²
                        div.style.backgroundSize = `${boardW}px ${h}px`;
                        div.style.backgroundPosition = `-${p.tx}px -${p.ty}px`;
                        div.style.transform = `translate(${p.x}px, ${p.y}px)`;
                        div.onpointerdown = (e) => handleDrag(e, pid);
                        board.appendChild(div);
                    }
                }
                document.getElementById('menu-screen').classList.remove('active');
                document.getElementById('game-screen').classList.add('active');
                document.getElementById('cur-lv-text').innerText = `Level ${id}`;
            }
        };

        function handleDrag(e, id) {
            if(isWin) return;
            const p = pieces.find(x => x.id === id);
            const group = pieces.filter(x => p.group.includes(x.id));
            const startX = e.clientX, startY = e.clientY;
            const initials = group.map(x => ({ id: x.id, x: x.x, y: x.y }));

            group.forEach(x => document.getElementById(`pc-${x.id}`).style.zIndex = 1000);

            const move = (ev) => {
                const dx = ev.clientX - startX, dy = ev.clientY - startY;
                group.forEach(x => {
                    const init = initials.find(i => i.id === x.id);
                    x.x = init.x + dx; x.y = init.y + dy;
                    document.getElementById(`pc-${x.id}`).style.transform = `translate(${x.x}px, ${x.y}px)`;
                });
            };

            const up = () => {
                window.removeEventListener('pointermove', move);
                window.removeEventListener('pointerup', up);
                checkFusion(p);
                group.forEach(x => document.getElementById(`pc-${x.id}`).style.zIndex = 10);
                checkWin();
            };
            window.addEventListener('pointermove', move);
            window.addEventListener('pointerup', up);
        }

        function checkFusion(p) {
            const myG = pieces.filter(x => p.group.includes(x.id));
            pieces.forEach(other => {
                if(p.group.includes(other.id)) return;
                myG.forEach(mine => {
                    const dx = (mine.x - other.x) - (mine.tx - other.tx);
                    const dy = (mine.y - other.y) - (mine.ty - other.ty);
                    if(Math.abs(dx) < 20 && Math.abs(dy) < 20) {
                        const newGroup = [...new Set([...p.group, ...other.group])];
                        const offX = other.x - other.tx, offY = other.y - other.ty;
                        pieces.forEach(x => {
                            if(newGroup.includes(x.id)) {
                                x.group = newGroup; x.x = x.tx + offX; x.y = x.ty + offY;
                                const el = document.getElementById(`pc-${x.id}`);
                                el.style.transition = "transform 0.2s";
                                el.style.transform = `translate(${x.x}px, ${x.y}px)`;
                                setTimeout(() => el.style.transition = '', 200);
                            }
                        });
                    }
                });
            });
        }

        async function checkWin() {
            if(pieces.every(x => x.group.length === pieces.length)) {
                isWin = true;
                const v = document.getElementById('victory-img');
                v.style.opacity = 1; v.style.transform = 'scale(1.1)';
                
                if(!completed.includes(currentL)) {
                    completed.push(currentL);
                    localStorage.setItem('puz_save_v51', JSON.stringify(completed));
                    if(_db) {
                        const uid = localStorage.getItem('puz_uid');
                        await _db.from('rankings').upsert({ id: uid, nickname: localStorage.getItem('puz_nick'), max_level: completed.length });
                    }
                }
                setTimeout(() => { if(currentL < 15) window.startLevel(currentL+1); else window.exitGame(); }, 1800);
            }
        }

        window.exitGame = () => {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            window.renderMenu();
        };

        window.toggleRank = async (show) => {
            const m = document.getElementById('rank-modal');
            m.style.display = show ? 'flex' : 'none';
            if(show && _db) {
                const listEl = document.getElementById('rank-list');
                listEl.innerHTML = 'åŠ è½½ä¸­...';
                const { data } = await _db.from('rankings').select('*').order('max_level', {ascending:false}).limit(10);
                listEl.innerHTML = data?.map((r,i) => `
                    <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333">
                        <span>${i+1}. ${r.nickname}</span>
                        <span style="color:var(--gold)">Lv.${r.max_level}</span>
                    </div>
                `).join('') || 'æš‚æ— æ•°æ®';
            }
        };

        // --- 3. è‡ªåŠ¨å¯åŠ¨ ---
        window.onload = () => {
            if(!localStorage.getItem('puz_nick')) {
                const n = prompt("æ¬¢è¿ï¼è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š") || "ç©å®¶" + Math.floor(Math.random()*1000);
                localStorage.setItem('puz_nick', n);
                localStorage.setItem('puz_uid', 'u_' + Date.now());
            }
            window.renderMenu();
        };
    </script>
</body>
</html>