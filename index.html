<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾å¤§å¸ˆ - v4.5 Supabase äº‘ç«¯ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-dark: #0f0f1e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --silver-grey: #bdc3c7;
            --gold: #f1c40f;
            --success-green: #2ecc71;
        }

        body {
            font-family: 'PingFang SC', sans-serif;
            background-color: var(--bg-dark); color: white; margin: 0; 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            overflow-x: hidden; -webkit-overflow-scrolling: touch;
        }

        /* --- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯æ  --- */
        #user-bar {
            width: 100%; max-width: 1000px; padding: 15px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* --- å¼¹çª—ä¸é®ç½© --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); padding: 20px; box-sizing: border-box;
        }

        #auth-modal .modal-content {
            background: #1a1a2e; padding: 30px; border-radius: 12px; border: 1px solid var(--primary-color);
            width: 90%; max-width: 350px; text-align: center;
        }
        #auth-modal input {
            width: 100%; padding: 12px; margin: 20px 0; border-radius: 6px; border: 1px solid #333;
            background: #0f0f1e; color: white; box-sizing: border-box; text-align: center; font-size: 1rem;
        }

        /* --- æ’è¡Œæ¦œ --- */
        #rank-modal .rank-container { width: 100%; max-width: 500px; height: 60vh; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; }
        .rank-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 40px; font-weight: bold; color: var(--silver-grey); }
        .rank-item.is-me {
            color: var(--success-green) !important;
            text-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
            border: 1px solid rgba(46, 204, 113, 0.4);
            background: rgba(46, 204, 113, 0.1);
            border-radius: 10px;
        }

        /* --- é¢„è§ˆ --- */
        #preview-img { max-width: 90%; max-height: 70%; border-radius: 8px; border: 1px solid #444; }

        /* --- æ¸¸æˆä¸»ç•Œé¢ --- */
        .screen { display: none; width: 100%; max-width: 1000px; padding: 20px; animation: fadeIn 0.3s; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; width: 100%; margin-top: 20px; }
        .level-card { background: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .card-thumb { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #1a1a2e; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        
        #board-container { padding: 10px; background: #1a1a2e; border-radius: 8px; position: relative; }
        .piece { box-sizing: border-box; background-repeat: no-repeat; border: 1px solid rgba(255, 255, 255, 0.2); touch-action: none; }
        #puzzle-board { display: grid; position: relative; background: #000; }
        .victory-zoom { transform: scale(1.3); opacity: 0; z-index: 100; transition: 1.2s; }
        #victory-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; z-index: 50; pointer-events: none; transition: opacity 0.3s; }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; background: #333; color: white; font-weight: bold; }
        #rank-btn { background: rgba(241, 196, 15, 0.15); color: var(--gold); border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <div id="preview-overlay" class="overlay">
        <h2>å…³å¡å›é¡¾</h2>
        <img id="preview-img" src="">
        <div style="display: flex; gap: 20px; margin-top: 30px;">
            <button class="btn" onclick="closePreview()">è¿”å›</button>
            <button class="btn" style="background:var(--primary-color)" id="replay-btn">å†æ¬¡æŒ‘æˆ˜</button>
        </div>
    </div>

    <div id="auth-modal" class="overlay">
        <div class="modal-content">
            <h2>ğŸŒ å…¨çƒæŒ‘æˆ˜å¼€å¯</h2>
            <p style="opacity: 0.6; font-size: 0.8rem;">è®¾ç½®æ˜µç§°ä»¥åŒæ­¥å…¨çƒæ’è¡Œæ¦œ</p>
            <input type="text" id="nickname-input" placeholder="è¾“å…¥æ˜µç§°..." maxlength="8">
            <button class="btn" style="width: 100%; background: var(--primary-color);" onclick="registerUser()">å¼€å§‹</button>
        </div>
    </div>

    <div id="rank-modal" class="overlay">
        <h2 style="color:var(--gold)">ğŸ† å…¨çƒè‹±é›„æ¦œ</h2>
        <div class="rank-container" id="rank-list"></div>
        <div id="my-rank-text" style="margin-top:15px; font-size: 0.9rem;"></div>
        <button class="btn" style="margin-top: 20px; width: 180px;" onclick="closeRank()">è¿”å›</button>
    </div>

    <div id="user-bar">
        <div class="user-info">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <div id="user-name" style="font-weight: bold; font-size: 0.9rem;">åŠ è½½ä¸­...</div>
                <div id="user-stat" style="font-size: 0.7rem; opacity: 0.5;">Lv.0</div>
            </div>
        </div>
        <button class="btn" id="rank-btn" onclick="openRank()">ğŸ† æ’è¡Œæ¦œ</button>
    </div>

    <div id="menu-screen" class="screen active">
        <h1 style="letter-spacing: 4px; margin: 10px 0;">ğŸ§© æ‹¼å›¾å¤§å¸ˆ <span style="font-size: 0.8rem; opacity: 0.3;">v4.5</span></h1>
        <div id="level-grid"></div>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="btn" onclick="showMenu()">â† èœå•</button>
            <h2 id="game-title">Level</h2>
            <div id="diff-label" style="font-size: 0.8rem; opacity: 0.6;">3x3</div>
        </div>
        <div id="board-container">
            <div id="puzzle-board"><img id="victory-overlay" src=""></div>
        </div>
    </div>

    <script>
        // --- è¯·æ›¿æ¢ä¸ºæ‚¨åœ¨ Supabase é¡¹ç›®ä¸­è·å–çš„çœŸå®ä¿¡æ¯ ---
        const SUPABASE_URL = 'https://afdnvaysvwdmbnxklogt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE';
        supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const FORMATS = ['.jpg', '.png', '.webp', '.jpeg'];
        let levelData = [], completedLevels = JSON.parse(localStorage.getItem('puz_comp_v31') || '[]');
        let currentImgUrl = '', currentLevelId = 1, rows, cols, pWidth, pHeight;
        let pieces = [], isVictoryProcessing = false;

        // --- äº‘ç«¯æ•°æ®é€»è¾‘ ---
        const DataService = {
            async getUser() {
                const id = localStorage.getItem('puz_user_id');
                const nick = localStorage.getItem('puz_nickname');
                return id ? { id, nick } : null;
            },
            async saveUser(nick) {
                // å‘äº‘ç«¯æ’å…¥æ–°ç”¨æˆ·
                const { data, error } = await supabase
                    .from('rankings')
                    .insert([{ nickname: nick, max_level: 0 }])
                    .select();
                
                if (error) { console.error(error); return null; }
                const user = data[0];
                localStorage.setItem('puz_user_id', user.id);
                localStorage.setItem('puz_nickname', user.nickname);
                return user;
            },
            async submitScore(level) {
                const id = localStorage.getItem('puz_user_id');
                if (!id) return;
                await supabase
                    .from('rankings')
                    .update({ max_level: level, updated_at: new Date() })
                    .eq('id', id);
            },
            async getRankings() {
                const { data, error } = await supabase
                    .from('rankings')
                    .select('*')
                    .order('max_level', { ascending: false })
                    .limit(50);
                
                const myId = localStorage.getItem('puz_user_id');
                return data.map(r => ({ ...r, isMe: r.id === myId }));
            }
        };

        // --- åˆå§‹åŒ– & UI ---
        async function init() {
            const user = await DataService.getUser();
            if (!user) document.getElementById('auth-modal').style.display = 'flex';
            else { updateUserUI(user.nick); discoverLevels(); }
        }

        async function registerUser() {
            const nick = document.getElementById('nickname-input').value.trim() || "ç©å®¶" + Math.floor(Math.random()*1000);
            const user = await DataService.saveUser(nick);
            if(user) {
                document.getElementById('auth-modal').style.display = 'none';
                updateUserUI(user.nickname); discoverLevels();
            }
        }

        function updateUserUI(nick) {
            document.getElementById('user-name').innerText = nick;
            document.getElementById('user-initial').innerText = nick[0].toUpperCase();
            const currentComp = JSON.parse(localStorage.getItem('puz_comp_v31') || '[]');
            const maxL = currentComp.length > 0 ? Math.max(...currentComp) : 0;
            document.getElementById('user-stat').innerText = `Lv.${maxL}`;
        }

        async function openRank() {
            const list = document.getElementById('rank-list');
            list.innerHTML = '<p style="text-align:center">æ­£åœ¨è¿æ¥å…¨çƒæœåŠ¡å™¨...</p>';
            document.getElementById('rank-modal').style.display = 'flex';

            const rankings = await DataService.getRankings();
            list.innerHTML = '';
            rankings.forEach((r, i) => {
                const item = document.createElement('div');
                item.className = `rank-item ${r.isMe ? 'is-me' : ''}`;
                item.innerHTML = `<div class="rank-num">${i + 1}</div><div style="flex:1">${r.nickname}</div><div>Lv.${r.max_level}</div>`;
                list.appendChild(item);
                if(r.isMe) document.getElementById('my-rank-text').innerText = `æ‚¨çš„æ’åï¼šç¬¬ ${i+1} å`;
            });
        }
        function closeRank() { document.getElementById('rank-modal').style.display = 'none'; }

        // --- æ ¸å¿ƒæ‹¼å›¾é€»è¾‘ (ç•¥ï¼ŒåŒä¹‹å‰ç‰ˆæœ¬) ---
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæ­¤å¤„çœç•¥å…·ä½“çš„æ‹¼å›¾æ‹–æ‹½ä»£ç ï¼Œä¿æŒä¹‹å‰çš„æ ¸å¿ƒç®—æ³•å³å¯
        // å…³é”®ç‚¹ï¼šåœ¨ checkWin() ä¸­å¢åŠ  DataService.submitScore(maxL);
        
        async function discoverLevels() {
            const currentMax = completedLevels.length > 0 ? Math.max(...completedLevels) : 0;
            for(let i=1; i<=currentMax+5; i++) {
                if(!levelData.find(l=>l.id===i)) {
                    const url = await findImage(i);
                    if(url) levelData.push({id:i, url});
                }
            }
            renderMenu();
        }

        async function findImage(id) {
            for (let ext of FORMATS) {
                const url = `${id}${ext}`;
                const exist = await new Promise(r => { 
                    const img = new Image(); img.onload=()=>r(true); img.onerror=()=>r(false); img.src=url; 
                });
                if(exist) return url;
            }
            return null;
        }

        function renderMenu() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            levelData.forEach(l => {
                const done = completedLevels.includes(l.id);
                const card = document.createElement('div');
                card.className = 'level-card';
                card.style.opacity = (l.id===1 || completedLevels.includes(l.id-1)) ? '1' : '0.3';
                card.innerHTML = `<div class="card-thumb">${done?`<img src="${l.url}">`:`<span>${l.id}</span>`}</div><div style="padding:5px;text-align:center;font-size:0.7rem">${done?'å·²è¾¾æˆ':'æŒ‘æˆ˜ä¸­'}</div>`;
                card.onclick = () => { if(done) showPreview(l.id); else startLevel(l.id); };
                grid.appendChild(card);
            });
        }

        function showPreview(id) {
            const l = levelData.find(x=>x.id===id);
            document.getElementById('preview-img').src = l.url;
            document.getElementById('preview-overlay').style.display = 'flex';
            document.getElementById('replay-btn').onclick = () => { closePreview(); startLevel(id); };
        }
        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }

        function startLevel(id) {
            currentLevelId = id; const l = levelData.find(x=>x.id===id);
            currentImgUrl = l.url; document.getElementById('victory-overlay').src = l.url;
            const img = new Image(); img.src = l.url;
            img.onload = () => {
                rows = 3; cols = 3; // ç¤ºä¾‹å›ºå®šéš¾åº¦
                pWidth = 300/cols; pHeight = (300*(img.height/img.width))/rows;
                initBoard();
                document.getElementById('menu-screen').classList.remove('active');
                document.getElementById('game-screen').classList.add('active');
                document.getElementById('game-title').innerText = `Level ${id}`;
            };
        }

        function initBoard() {
            pieces = []; for(let i=0; i<rows*cols; i++) pieces.push({id:i, currentPos:i, bgX:(i%cols)*pWidth, bgY:Math.floor(i/cols)*pHeight});
            let pool = [...Array(rows*cols).keys()].sort(()=>Math.random()-0.5);
            pieces.forEach((p,i)=>p.currentPos=pool[i]);
            renderPieces();
        }

        function renderPieces() {
            const b = document.getElementById('puzzle-board'); b.innerHTML = ''; b.appendChild(document.getElementById('victory-overlay'));
            b.style.width = `${pWidth*cols}px`; b.style.gridTemplateColumns = `repeat(${cols}, ${pWidth}px)`;
            pieces.sort((a,b)=>a.currentPos-b.currentPos).forEach(p => {
                const d = document.createElement('div'); d.className = 'piece';
                d.style.width=`${pWidth}px`; d.style.height=`${pHeight}px`;
                d.style.backgroundImage=`url(${currentImgUrl})`; d.style.backgroundPosition=`-${p.bgX}px -${p.bgY}px`;
                d.style.backgroundSize=`${pWidth*cols}px ${pHeight*rows}px`;
                d.onpointerdown = e => handleDrag(e, p.id);
                b.appendChild(d);
            });
        }

        function handleDrag(e, id) {
            const startX = e.clientX, startY = e.clientY;
            window.onpointermove = ev => {
                const el = document.querySelector(`[style*="background-position: -${pieces.find(x=>x.id===id).bgX}px"]`);
                if(el) el.style.transform = `translate(${ev.clientX-startX}px, ${ev.clientY-startY}px)`;
            };
            window.onpointerup = ev => {
                window.onpointermove = null;
                // æ­¤å¤„ç®€åŒ–äº†äº¤æ¢é€»è¾‘ï¼Œä»…åšç¤ºæ„
                renderPieces(); checkWin();
            };
        }

        async function checkWin() {
            if (pieces.every(p => p.id === p.currentPos)) {
                if(!completedLevels.includes(currentLevelId)) {
                    completedLevels.push(currentLevelId);
                    localStorage.setItem('puz_comp_v31', JSON.stringify(completedLevels));
                    await DataService.submitScore(Math.max(...completedLevels));
                }
                updateUserUI(localStorage.getItem('puz_nickname'));
                alert('æ­å–œé€šå…³ï¼'); showMenu();
            }
        }

        function showMenu() { document.getElementById('game-screen').classList.remove('active'); document.getElementById('menu-screen').classList.add('active'); renderMenu(); }

        init();
    </script>
</body>
</html>