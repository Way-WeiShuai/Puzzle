<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾å¤§å¸ˆ - v4.9 ç¨³å®šä¿®å¤ç‰ˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4a90e2;
            --dark: #0f0f1e;
            --glass: rgba(255, 255, 255, 0.05);
            --gold: #f1c40f;
        }
        body {
            font-family: sans-serif; background: var(--dark); color: white; margin: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            touch-action: none; /* é˜²æ­¢æ‰‹æœºç«¯ä¸‹æ‹‰åˆ·æ–°å¹²æ‰° */
            overflow-x: hidden;
        }

        /* é¡¶éƒ¨æ  */
        #top-bar {
            width: 100%; max-width: 600px; padding: 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid #333;
            z-index: 10;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1a1a2e; padding: 25px; border-radius: 15px; width: 80%; max-width: 350px;
            text-align: center; border: 1px solid #333;
        }

        /* æ¸¸æˆæ¿å®¹å™¨ - å…³é”®é€‚é… */
        #game-area {
            position: relative; margin-top: 20px;
            transition: transform 0.3s;
            /* é™åˆ¶æœ€å¤§å®½é«˜ï¼Œé˜²æ­¢è¶…å‡ºæ‰‹æœºå±å¹• */
            max-width: 96vw; 
            max-height: 75vh;
            display: flex; justify-content: center; align-items: center;
        }
        #puzzle-board {
            position: relative; border: 2px solid #444; background: #000;
            /* é»˜è®¤éšè—ï¼ŒJSè®¡ç®—å¥½å°ºå¯¸åå†æ˜¾ç¤º */
            visibility: hidden; 
        }
        .piece {
            position: absolute; border: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box; transition: transform 0.1s;
        }

        /* å…³å¡åˆ—è¡¨ */
        #menu-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; width: 92%; max-width: 600px; padding: 20px 0; }
        .level-btn {
            background: var(--glass); border: 1px solid #333; border-radius: 10px;
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .level-btn img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; opacity: 0.5; }
        .level-btn span { z-index: 2; font-weight: bold; text-shadow: 0 1px 3px black; }

        /* é€šç”¨æŒ‰é’® */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-blue { background: var(--primary); color: #fff; }

        /* ç•Œé¢åˆ‡æ¢ */
        .screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
    </style>
</head>
<body>

    <div id="auth-modal" class="modal" style="display: flex;">
        <div class="modal-box">
            <h2 style="color:white; margin-top:0;">æ¬¢è¿æ¥åˆ°æ‹¼å›¾å¤§å¸ˆ</h2>
            <p style="color:#aaa; font-size:0.9rem;">è¯·è¾“å…¥ä½ çš„åå­—å¼€å§‹æŒ‘æˆ˜</p>
            <input type="text" id="nick-input" placeholder="ä½ çš„æ˜µç§°" style="width:100%; padding:10px; margin:15px 0; background:#000; color:white; border:1px solid #444; border-radius:5px; box-sizing:border-box;">
            <button class="btn btn-blue" style="width:100%" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <div id="rank-modal" class="modal">
        <div class="modal-box" style="height: 60vh; display: flex; flex-direction: column;">
            <h3 style="color:var(--gold); margin:0 0 15px 0;">ğŸ† ä¸–ç•Œæ’è¡Œæ¦œ</h3>
            <div id="rank-list" style="flex:1; overflow-y: auto; text-align: left; margin-bottom: 15px;">
                åŠ è½½ä¸­...
            </div>
            <button class="btn" onclick="document.getElementById('rank-modal').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <div id="top-bar">
        <div class="user-info">
            <div class="avatar" id="ui-avatar">?</div>
            <div>
                <div id="ui-name" style="font-weight:bold;">Guest</div>
                <div id="ui-lv" style="font-size:0.8rem; color:#aaa;">Lv.0</div>
            </div>
        </div>
        <button class="btn btn-gold" onclick="openRank()">æ’è¡Œæ¦œ</button>
    </div>

    <div id="menu-screen" class="screen active">
        <h3 style="margin: 10px 0 0 0; opacity: 0.6;">é€‰æ‹©å…³å¡</h3>
        <div id="menu-view"></div>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; margin-top:10px;">
            <button class="btn" style="background:#333; color:#fff" onclick="backToMenu()">â† é€€å‡º</button>
            <span id="level-title">Level 1</span>
        </div>
        <div id="game-area">
            <div id="puzzle-board"></div>
            <img id="win-img" style="position:absolute; width:100%; height:100%; opacity:0; pointer-events:none; transition:1s;">
        </div>
    </div>

    <script>
        // === æ ¸å¿ƒä¿®å¤ï¼šå˜é‡åä½¿ç”¨ _db é¿å…å†²çª ===
        const SB_URL = 'https://afdnvaysvwdmbnxklogt.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE';
        
        let _db = null;
        try {
            // ä½¿ç”¨ window.supabase ç¡®ä¿è°ƒç”¨çš„æ˜¯å…¨å±€å¯¹è±¡
            if(window.supabase) {
                _db = window.supabase.createClient(SB_URL, SB_KEY);
                console.log("æ•°æ®åº“è¿æ¥æˆåŠŸ");
            }
        } catch(e) {
            console.error("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:", e);
        }

        // === æ¸¸æˆæ•°æ® ===
        let myData = {
            uid: localStorage.getItem('puz_uid_v49'),
            nick: localStorage.getItem('puz_nick_v49'),
            levels: JSON.parse(localStorage.getItem('puz_lv_v49') || '[]')
        };

        // === 1. åˆå§‹åŒ–é€»è¾‘ ===
        function init() {
            if(myData.nick) {
                document.getElementById('auth-modal').style.display = 'none';
                updateUI();
                renderMenu();
                syncData(); // åå°åŒæ­¥
            }
        }

        function startGame() {
            const val = document.getElementById('nick-input').value.trim();
            if(!val) return alert("èµ·ä¸ªåå­—å§ï¼");
            
            // ç”Ÿæˆæ–°ç”¨æˆ·
            myData.nick = val;
            myData.uid = 'u_' + Date.now().toString(36);
            localStorage.setItem('puz_nick_v49', myData.nick);
            localStorage.setItem('puz_uid_v49', myData.uid);
            
            document.getElementById('auth-modal').style.display = 'none';
            updateUI();
            renderMenu();
            syncData();
        }

        function updateUI() {
            document.getElementById('ui-name').innerText = myData.nick;
            document.getElementById('ui-avatar').innerText = myData.nick[0].toUpperCase();
            document.getElementById('ui-lv').innerText = `å·²é€šè¿‡: ${myData.levels.length}å…³`;
        }

        // === 2. å…³å¡èœå• ===
        function renderMenu() {
            const list = document.getElementById('menu-view');
            list.innerHTML = '';
            // æ˜¾ç¤ºå·²å®Œæˆ + æœªæ¥5å…³
            const maxShow = myData.levels.length + 5;
            
            for(let i=1; i<=maxShow; i++) {
                const isDone = myData.levels.includes(i);
                const isLock = i > 1 && !myData.levels.includes(i-1);
                
                const div = document.createElement('div');
                div.className = 'level-btn';
                div.style.opacity = isLock ? '0.3' : '1';
                // å¦‚æœå·²å®Œæˆï¼Œå°è¯•æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œå¦åˆ™æ˜¾ç¤ºæ•°å­—
                div.innerHTML = isDone ? 
                    `<img src="${i}.jpg"><span>âœ… ${i}</span>` : 
                    `<span>${isLock ? 'ğŸ”’' : i}</span>`;
                
                if(!isLock) {
                    div.onclick = () => loadLevel(i);
                }
                list.appendChild(div);
            }
        }

        // === 3. æ¸¸æˆæ ¸å¿ƒ (ä¿®å¤é€‚é…é—®é¢˜) ===
        let gState = { id:0, pieces:[], rows:0, cols:0, pw:0, ph:0, moving:false };

        function loadLevel(id) {
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('level-title').innerText = `Level ${id} åŠ è½½ä¸­...`;
            document.getElementById('game-area').style.transform = 'none';
            document.getElementById('win-img').style.opacity = '0';
            
            const img = new Image();
            img.src = `${id}.jpg`;
            img.onload = () => {
                startPuzzle(img, id);
            };
            img.onerror = () => {
                alert(`æ‰¾ä¸åˆ°å›¾ç‰‡ ${id}.jpgï¼Œè¯·ç¡®ä¿å›¾ç‰‡å·²ä¸Šä¼ `);
                backToMenu();
            };
        }

        function startPuzzle(img, id) {
            gState.id = id;
            const ratio = img.width / img.height;
            // éš¾åº¦è®¡ç®—
            gState.cols = 3 + Math.floor((id-1)/3); 
            gState.rows = Math.round(gState.cols / ratio);

            // --- å…³é”®ï¼šè‡ªé€‚åº”å±å¹•å¤§å° ---
            const screenW = window.innerWidth * 0.94; // ç•™å‡ºä¸€ç‚¹è¾¹è·
            const screenH = window.innerHeight * 0.70;

            // 1. å…ˆæŒ‰å®½åº¦ç®—
            gState.pw = Math.floor(screenW / gState.cols);
            gState.ph = Math.floor(gState.pw / ratio);

            // 2. å¦‚æœé«˜åº¦è¶…äº†ï¼Œå°±æŒ‰é«˜åº¦åç®—
            if(gState.ph * gState.rows > screenH) {
                gState.ph = Math.floor(screenH / gState.rows);
                gState.pw = Math.floor(gState.ph * ratio);
            }

            // è®¾ç½®æ£‹ç›˜
            const board = document.getElementById('puzzle-board');
            board.style.width = (gState.pw * gState.cols) + 'px';
            board.style.height = (gState.ph * gState.rows) + 'px';
            board.style.visibility = 'visible';
            board.innerHTML = '';

            document.getElementById('win-img').src = img.src;
            document.getElementById('level-title').innerText = `Level ${id}`;

            // ç”Ÿæˆç¢ç‰‡
            gState.pieces = [];
            for(let i=0; i < gState.rows * gState.cols; i++) {
                gState.pieces.push({
                    id: i, // æ­£ç¡®ä½ç½®ID
                    cur: i, // å½“å‰ä½ç½®ID
                    x: (i % gState.cols) * gState.pw,
                    y: Math.floor(i / gState.cols) * gState.ph
                });
            }

            // æ‰“ä¹± (Fisher-Yates)
            let indexes = gState.pieces.map(p => p.id);
            for(let i = indexes.length -1; i>0; i--){
                const j = Math.floor(Math.random()*(i+1));
                [indexes[i], indexes[j]] = [indexes[j], indexes[i]];
            }
            gState.pieces.forEach((p, i) => p.cur = indexes[i]);

            renderBoard(img.src);
        }

        function renderBoard(url) {
            const board = document.getElementById('puzzle-board');
            board.innerHTML = '';

            gState.pieces.forEach(p => {
                const div = document.createElement('div');
                div.className = 'piece';
                div.style.width = gState.pw + 'px';
                div.style.height = gState.ph + 'px';
                div.style.backgroundImage = `url(${url})`;
                div.style.backgroundSize = `${gState.cols*gState.pw}px ${gState.rows*gState.ph}px`;
                div.style.backgroundPosition = `-${p.x}px -${p.y}px`;
                
                // è®¡ç®—å½“å‰å®ƒåœ¨æ£‹ç›˜çš„å“ªä¸ªæ ¼å­é‡Œ
                const curRow = Math.floor(p.cur / gState.cols);
                const curCol = p.cur % gState.cols;
                div.style.left = (curCol * gState.pw) + 'px';
                div.style.top = (curRow * gState.ph) + 'px';
                
                // è§†è§‰èåˆï¼šæ£€æŸ¥å³è¾¹å’Œä¸‹è¾¹æ˜¯å¦æ˜¯â€œæ­£ç¡®é‚»å±…â€
                const right = gState.pieces.find(x => x.cur === p.cur + 1);
                const down = gState.pieces.find(x => x.cur === p.cur + gState.cols);
                
                // å¦‚æœå³è¾¹æœ‰äººï¼Œä¸”é‚£å°±æ˜¯æˆ‘åŸå§‹çš„å³è¾¹é‚»å±… -> éšè—å³è¾¹æ¡†
                if(curCol < gState.cols-1 && right && right.id === p.id + 1) {
                    div.style.borderRight = 'none';
                }
                // åŒç†ä¸‹æ–¹
                if(curRow < gState.rows-1 && down && down.id === p.id + gState.cols) {
                    div.style.borderBottom = 'none';
                }

                div.onpointerdown = (e) => handleTouch(e, p);
                board.appendChild(div);
            });
        }

        // === 4. æ‹–æ‹½é€»è¾‘ ===
        function handleTouch(e, p) {
            if(gState.moving) return;
            // ç®€å•ç‰ˆæœ¬ï¼šç‚¹å‡»åªæ˜¯é«˜äº®ï¼Œæˆ–è€…å®ç°äº¤æ¢ï¼Ÿ
            // è¿™é‡Œå®ç°æ‹–æ‹½äº¤æ¢
            const startX = e.clientX, startY = e.clientY;
            const el = e.target;
            el.style.zIndex = 100;
            
            // æ‰¾åˆ°æ‰€æœ‰è¿é€šçš„å—ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºåªæ‹–å½“å‰å—ï¼Œå¤æ‚è¿é€šé€»è¾‘æ˜“å‡ºé”™ï¼Œå…ˆä¿ç¨³ï¼‰
            // å¦‚æœéœ€è¦è¿é€šå—é€»è¾‘ï¼Œå¯å¤ç”¨ä¹‹å‰ç‰ˆæœ¬ï¼Œè¿™é‡Œä¸ºäº†ç¨³ï¼Œå…ˆåšå•å—äº¤æ¢/ç§»åŠ¨
            
            document.onpointermove = (ev) => {
                const dx = ev.clientX - startX;
                const dy = ev.clientY - startY;
                el.style.transform = `translate(${dx}px, ${dy}px)`;
            };

            document.onpointerup = (ev) => {
                document.onpointermove = null;
                document.onpointerup = null;
                el.style.transform = 'none';
                el.style.zIndex = '';

                // è®¡ç®—æ‹–åˆ°äº†å“ªä¸ªæ ¼å­ä¸Š
                const dx = ev.clientX - startX;
                const dy = ev.clientY - startY;
                
                // å¿…é¡»ç§»åŠ¨è¶…è¿‡ä¸€åŠæ ¼å­æ‰ç®—æ„å›¾äº¤æ¢
                if(Math.abs(dx) > gState.pw/2 || Math.abs(dy) > gState.ph/2) {
                    const moveCol = Math.round(dx / gState.pw);
                    const moveRow = Math.round(dy / gState.ph);
                    
                    const curR = Math.floor(p.cur / gState.cols);
                    const curC = p.cur % gState.cols;
                    const tarR = curR + moveRow;
                    const tarC = curC + moveCol;

                    if(tarR >=0 && tarR < gState.rows && tarC >=0 && tarC < gState.cols) {
                        const tarIndex = tarR * gState.cols + tarC;
                        const targetPiece = gState.pieces.find(x => x.cur === tarIndex);
                        
                        // äº¤æ¢æ•°æ®
                        if(targetPiece) {
                            const tmp = p.cur;
                            p.cur = targetPiece.cur;
                            targetPiece.cur = tmp;
                            // é‡æ–°æ¸²æŸ“
                            const img = document.getElementById('win-img'); // è·å–å½“å‰å›¾URL
                            renderBoard(img.src);
                            checkWin();
                        }
                    }
                }
            };
        }

        function checkWin() {
            const isWin = gState.pieces.every(p => p.id === p.cur);
            if(isWin) {
                document.getElementById('win-img').style.opacity = '1';
                document.getElementById('puzzle-board').innerHTML = ''; // æ¸…ç©ºæ ¼å­æ˜¾ç¤ºå®Œæ•´å›¾
                
                if(!myData.levels.includes(gState.id)) {
                    myData.levels.push(gState.id);
                    localStorage.setItem('puz_lv_v49', JSON.stringify(myData.levels));
                    syncData();
                    updateUI();
                }

                setTimeout(() => {
                    alert("ğŸ‰ æ‹¼å›¾å®Œæˆï¼");
                    backToMenu();
                }, 1500);
            }
        }

        function backToMenu() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            renderMenu();
        }

        // === 5. æ’è¡Œæ¦œä¸æ•°æ®åŒæ­¥ ===
        async function syncData() {
            if(!_db) return;
            // ä¸Šä¼ 
            await _db.from('rankings').upsert({
                id: myData.uid,
                nickname: myData.nick,
                max_level: myData.levels.length,
                updated_at: new Date()
            });
        }

        async function openRank() {
            const modal = document.getElementById('rank-modal');
            const list = document.getElementById('rank-list');
            modal.style.display = 'flex';
            list.innerHTML = 'æ­£åœ¨åŠ è½½æ•°æ®...';

            if(!_db) {
                list.innerHTML = 'æ’è¡ŒæœåŠ¡æœªè¿æ¥';
                return;
            }

            const { data, error } = await _db.from('rankings')
                .select('*')
                .order('max_level', { ascending: false })
                .limit(20);

            if(error) {
                list.innerHTML = 'åŠ è½½å¤±è´¥: ' + error.message;
            } else {
                list.innerHTML = data.map((r, i) => `
                    <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                        <span style="color:${i<3?'gold':'white'}">#${i+1} ${r.nickname}</span>
                        <span style="color:#aaa">Lv.${r.max_level}</span>
                    </div>
                `).join('');
            }
        }

        // å¯åŠ¨
        window.onload = init;

    </script>
</body>
</html>