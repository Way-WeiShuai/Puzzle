<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾å¤§å¸ˆ - v5.0 è‡ªåŠ¨ä¿®å¤ç‰ˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4a90e2;
            --dark: #0f0f1e;
            --glass: rgba(255, 255, 255, 0.05);
            --gold: #f1c40f;
        }
        body {
            font-family: sans-serif; background: var(--dark); color: white; margin: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            touch-action: none; overflow-x: hidden;
        }

        /* é¡¶éƒ¨æ  */
        #top-bar {
            width: 100%; max-width: 600px; padding: 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid #333;
            z-index: 10;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1a1a2e; padding: 25px; border-radius: 15px; width: 80%; max-width: 350px;
            text-align: center; border: 1px solid #333;
        }

        /* æ¸¸æˆæ¿å®¹å™¨ - å…³é”®é€‚é… */
        #game-area {
            position: relative; margin-top: 20px;
            transition: transform 0.3s;
            max-width: 96vw; max-height: 75vh;
            display: flex; justify-content: center; align-items: center;
        }
        #puzzle-board {
            position: relative; border: 2px solid #444; background: #000;
            visibility: hidden; /* è®¡ç®—å¥½å°ºå¯¸å‰éšè— */
        }
        .piece {
            position: absolute; border: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box; transition: transform 0.1s;
        }

        /* å…³å¡åˆ—è¡¨ */
        #menu-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; width: 92%; max-width: 600px; padding: 20px 0; }
        .level-btn {
            background: var(--glass); border: 1px solid #333; border-radius: 10px;
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
        }
        /* ç¼©ç•¥å›¾ä¹ŸåŠ ä¸Š onerror å¤„ç† */
        .level-btn img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; opacity: 0.5; }
        .level-btn span { z-index: 2; font-weight: bold; text-shadow: 0 1px 3px black; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-blue { background: var(--primary); color: #fff; }

        .screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
    </style>
</head>
<body>

    <div id="auth-modal" class="modal" style="display: flex;">
        <div class="modal-box">
            <h2 style="color:white; margin-top:0;">æ¬¢è¿æ¥åˆ°æ‹¼å›¾å¤§å¸ˆ</h2>
            <p style="color:#aaa; font-size:0.9rem;">è¯·è¾“å…¥ä½ çš„åå­—å¼€å§‹æŒ‘æˆ˜</p>
            <input type="text" id="nick-input" placeholder="ä½ çš„æ˜µç§°" style="width:100%; padding:10px; margin:15px 0; background:#000; color:white; border:1px solid #444; border-radius:5px; box-sizing:border-box;">
            <button class="btn btn-blue" style="width:100%" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <div id="rank-modal" class="modal">
        <div class="modal-box" style="height: 60vh; display: flex; flex-direction: column;">
            <h3 style="color:var(--gold); margin:0 0 15px 0;">ğŸ† ä¸–ç•Œæ’è¡Œæ¦œ</h3>
            <div id="rank-list" style="flex:1; overflow-y: auto; text-align: left; margin-bottom: 15px;">
                åŠ è½½ä¸­...
            </div>
            <button class="btn" onclick="document.getElementById('rank-modal').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <div id="top-bar">
        <div class="user-info">
            <div class="avatar" id="ui-avatar">?</div>
            <div>
                <div id="ui-name" style="font-weight:bold;">Guest</div>
                <div id="ui-lv" style="font-size:0.8rem; color:#aaa;">Lv.0</div>
            </div>
        </div>
        <button class="btn btn-gold" onclick="openRank()">æ’è¡Œæ¦œ</button>
    </div>

    <div id="menu-screen" class="screen active">
        <h3 style="margin: 10px 0 0 0; opacity: 0.6;">é€‰æ‹©å…³å¡</h3>
        <div id="menu-view"></div>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; margin-top:10px;">
            <button class="btn" style="background:#333; color:#fff" onclick="backToMenu()">â† é€€å‡º</button>
            <span id="level-title">Level 1</span>
        </div>
        <div id="game-area">
            <div id="puzzle-board"></div>
            <img id="win-img" style="position:absolute; width:100%; height:100%; opacity:0; pointer-events:none; transition:1s;">
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const SB_URL = 'https://afdnvaysvwdmbnxklogt.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE';
        
        let _db = null;
        try {
            if(window.supabase) _db = window.supabase.createClient(SB_URL, SB_KEY);
        } catch(e) { console.error("DB Error:", e); }

        let myData = {
            uid: localStorage.getItem('puz_uid_v50'),
            nick: localStorage.getItem('puz_nick_v50'),
            levels: JSON.parse(localStorage.getItem('puz_lv_v50') || '[]')
        };

        // --- 1. åˆå§‹åŒ– ---
        function init() {
            if(myData.nick) {
                document.getElementById('auth-modal').style.display = 'none';
                updateUI();
                renderMenu();
                syncData();
            }
        }

        function startGame() {
            const val = document.getElementById('nick-input').value.trim();
            if(!val) return alert("èµ·ä¸ªåå­—å§ï¼");
            myData.nick = val;
            myData.uid = 'u_' + Date.now().toString(36);
            localStorage.setItem('puz_nick_v50', myData.nick);
            localStorage.setItem('puz_uid_v50', myData.uid);
            document.getElementById('auth-modal').style.display = 'none';
            updateUI();
            renderMenu();
            syncData();
        }

        function updateUI() {
            document.getElementById('ui-name').innerText = myData.nick;
            document.getElementById('ui-avatar').innerText = myData.nick[0].toUpperCase();
            document.getElementById('ui-lv').innerText = `å·²é€šè¿‡: ${myData.levels.length}å…³`;
        }

        // --- 2. å…³å¡èœå• (ä¿®å¤ç¼©ç•¥å›¾åŠ è½½å¤±è´¥) ---
        function renderMenu() {
            const list = document.getElementById('menu-view');
            list.innerHTML = '';
            const maxShow = myData.levels.length + 5;
            
            for(let i=1; i<=maxShow; i++) {
                const isDone = myData.levels.includes(i);
                const isLock = i > 1 && !myData.levels.includes(i-1);
                
                const div = document.createElement('div');
                div.className = 'level-btn';
                div.style.opacity = isLock ? '0.3' : '1';
                
                // è‡ªåŠ¨æ›¿è¡¥é€»è¾‘ï¼šå¦‚æœæœ¬åœ°å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç½‘ç»œå›¾
                const backupUrl = `https://picsum.photos/200/200?random=${i}`;
                
                div.innerHTML = `
                    ${isDone || !isLock ? 
                        `<img src="${i}.jpg" onerror="this.src='${backupUrl}'">` : ''}
                    <span>${isDone ? 'âœ…' : (isLock ? 'ğŸ”’' : i)}</span>
                `;
                
                if(!isLock) div.onclick = () => loadLevel(i);
                list.appendChild(div);
            }
        }

        // --- 3. æ¸¸æˆåŠ è½½æ ¸å¿ƒ (ä¿®å¤å›¾ç‰‡æŠ¥é”™æ— æ³•è¿›å…¥) ---
        let gState = { id:0, pieces:[], rows:0, cols:0, pw:0, ph:0, moving:false };

        function loadLevel(id) {
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('level-title').innerText = `åŠ è½½ä¸­...`;
            document.getElementById('game-area').style.transform = 'none';
            document.getElementById('win-img').style.opacity = '0';
            
            // å…³é”®ä¿®å¤é€»è¾‘ï¼š
            const img = new Image();
            img.crossOrigin = "Anonymous"; // å…è®¸è·¨åŸŸï¼Œé˜²æ­¢ç”»å¸ƒæ±¡æŸ“
            
            // å®šä¹‰æˆåŠŸå›è°ƒ
            img.onload = () => startPuzzle(img, id);
            
            // å®šä¹‰å¤±è´¥å›è°ƒï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ç½‘ç»œå›¾
            img.onerror = () => {
                console.warn(`æœ¬åœ°å›¾ç‰‡ ${id}.jpg æœªæ‰¾åˆ°ï¼Œåˆ‡æ¢åˆ°ç½‘ç»œå¤‡ä»½å›¾`);
                // é˜²æ­¢æ— é™å¾ªç¯ï¼šå¦‚æœæ˜¯ç½‘ç»œå›¾ä¹ŸæŒ‚äº†ï¼Œå°±ç»ˆæ­¢
                if(img.src.includes('picsum.photos')) {
                    alert("ç½‘ç»œå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
                    backToMenu();
                    return;
                }
                // ä½¿ç”¨ Picsum æä¾›çš„é«˜æ¸…éšæœºå›¾ï¼Œå¸¦ä¸Šéšæœºå‚æ•°ä¿è¯æ¯å…³ä¸ä¸€æ ·
                img.src = `https://picsum.photos/800/800?random=${id}`;
            };

            // 1. å…ˆå°è¯•åŠ è½½æœ¬åœ°å›¾ç‰‡
            img.src = `${id}.jpg`;
        }

        function startPuzzle(img, id) {
            gState.id = id;
            const ratio = img.width / img.height;
            gState.cols = 3 + Math.floor((id-1)/3); 
            gState.rows = Math.round(gState.cols / ratio);

            // é€‚é…å±å¹•
            const screenW = window.innerWidth * 0.94;
            const screenH = window.innerHeight * 0.70;

            gState.pw = Math.floor(screenW / gState.cols);
            gState.ph = Math.floor(gState.pw / ratio);

            if(gState.ph * gState.rows > screenH) {
                gState.ph = Math.floor(screenH / gState.rows);
                gState.pw = Math.floor(gState.ph * ratio);
            }

            const board = document.getElementById('puzzle-board');
            board.style.width = (gState.pw * gState.cols) + 'px';
            board.style.height = (gState.ph * gState.rows) + 'px';
            board.style.visibility = 'visible';
            board.innerHTML = '';

            document.getElementById('win-img').src = img.src;
            document.getElementById('level-title').innerText = `Level ${id}`;

            gState.pieces = [];
            for(let i=0; i < gState.rows * gState.cols; i++) {
                gState.pieces.push({
                    id: i, cur: i,
                    x: (i % gState.cols) * gState.pw,
                    y: Math.floor(i / gState.cols) * gState.ph
                });
            }

            // æ‰“ä¹±
            let indexes = gState.pieces.map(p => p.id);
            for(let i = indexes.length -1; i>0; i--){
                const j = Math.floor(Math.random()*(i+1));
                [indexes[i], indexes[j]] = [indexes[j], indexes[i]];
            }
            gState.pieces.forEach((p, i) => p.cur = indexes[i]);

            renderBoard(img.src);
        }

        function renderBoard(url) {
            const board = document.getElementById('puzzle-board');
            board.innerHTML = '';
            gState.pieces.forEach(p => {
                const div = document.createElement('div');
                div.className = 'piece';
                div.style.width = gState.pw + 'px'; div.style.height = gState.ph + 'px';
                div.style.backgroundImage = `url(${url})`;
                div.style.backgroundSize = `${gState.cols*gState.pw}px ${gState.rows*gState.ph}px`;
                div.style.backgroundPosition = `-${p.x}px -${p.y}px`;
                
                const r = Math.floor(p.cur / gState.cols), c = p.cur % gState.cols;
                div.style.left = (c * gState.pw) + 'px';
                div.style.top = (r * gState.ph) + 'px';
                
                // è¾¹æ¡†èåˆ
                const right = gState.pieces.find(x => x.cur === p.cur + 1);
                const down = gState.pieces.find(x => x.cur === p.cur + gState.cols);
                if(c < gState.cols-1 && right && right.id === p.id + 1) div.style.borderRight = 'none';
                if(r < gState.rows-1 && down && down.id === p.id + gState.cols) div.style.borderBottom = 'none';

                div.onpointerdown = (e) => handleTouch(e, p);
                board.appendChild(div);
            });
        }

        function handleTouch(e, p) {
            if(gState.moving) return;
            const startX = e.clientX, startY = e.clientY;
            const el = e.target;
            el.style.zIndex = 100;
            
            document.onpointermove = (ev) => {
                el.style.transform = `translate(${ev.clientX - startX}px, ${ev.clientY - startY}px)`;
            };

            document.onpointerup = (ev) => {
                document.onpointermove = null; document.onpointerup = null;
                el.style.transform = 'none'; el.style.zIndex = '';
                
                const dx = ev.clientX - startX, dy = ev.clientY - startY;
                if(Math.abs(dx) > gState.pw/2 || Math.abs(dy) > gState.ph/2) {
                    const mC = Math.round(dx / gState.pw), mR = Math.round(dy / gState.ph);
                    const cR = Math.floor(p.cur / gState.cols), cC = p.cur % gState.cols;
                    const tR = cR + mR, tC = cC + mC;

                    if(tR >=0 && tR < gState.rows && tC >=0 && tC < gState.cols) {
                        const target = gState.pieces.find(x => x.cur === tR * gState.cols + tC);
                        if(target) {
                            [p.cur, target.cur] = [target.cur, p.cur];
                            renderBoard(document.getElementById('win-img').src);
                            checkWin();
                        }
                    }
                }
            };
        }

        function checkWin() {
            if(gState.pieces.every(p => p.id === p.cur)) {
                document.getElementById('win-img').style.opacity = '1';
                document.getElementById('puzzle-board').innerHTML = '';
                if(!myData.levels.includes(gState.id)) {
                    myData.levels.push(gState.id);
                    localStorage.setItem('puz_lv_v50', JSON.stringify(myData.levels));
                    syncData();
                    updateUI();
                }
                setTimeout(() => { alert("ğŸ‰ æ‹¼å›¾å®Œæˆï¼"); backToMenu(); }, 1500);
            }
        }

        function backToMenu() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            renderMenu();
        }

        async function syncData() {
            if(!_db) return;
            await _db.from('rankings').upsert({
                id: myData.uid, nickname: myData.nick,
                max_level: myData.levels.length, updated_at: new Date()
            });
        }

        async function openRank() {
            const list = document.getElementById('rank-list');
            document.getElementById('rank-modal').style.display = 'flex';
            list.innerHTML = 'åŠ è½½ä¸­...';
            if(!_db) return list.innerHTML = 'æœªè¿æ¥æœåŠ¡å™¨';
            
            const { data } = await _db.from('rankings').select('*').order('max_level', {ascending:false}).limit(20);
            list.innerHTML = (data||[]).map((r,i) => `
                <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                    <span style="color:${i<3?'gold':'white'}">#${i+1} ${r.nickname}</span>
                    <span style="color:#aaa">Lv.${r.max_level}</span>
                </div>
            `).join('') || 'æš‚æ— æ•°æ®';
        }

        window.onload = init;
    </script>
</body>
</html>