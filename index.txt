<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾å¤§å¸ˆ - v4.5 ç¨³å®šç‰ˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-dark: #0f0f1e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --silver-grey: #bdc3c7;
            --gold: #f1c40f;
            --success-green: #2ecc71;
        }

        body {
            font-family: 'PingFang SC', sans-serif;
            background-color: var(--bg-dark); color: white; margin: 0; 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            overflow-x: hidden; -webkit-overflow-scrolling: touch;
        }

        /* --- ç”¨æˆ·ä¿¡æ¯æ  --- */
        #user-bar {
            width: 100%; max-width: 1000px; padding: 15px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); padding: 20px; box-sizing: border-box;
        }

        #auth-modal .modal-content {
            background: #1a1a2e; padding: 30px; border-radius: 12px; border: 1px solid var(--primary-color);
            width: 90%; max-width: 350px; text-align: center;
        }
        #auth-modal input {
            width: 100%; padding: 12px; margin: 20px 0; border-radius: 6px; border: 1px solid #333;
            background: #0f0f1e; color: white; box-sizing: border-box; text-align: center; font-size: 1rem;
        }

        /* --- æ’è¡Œæ¦œ --- */
        #rank-modal .rank-container {
            width: 100%; max-width: 500px; height: 60vh; overflow-y: auto;
            background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px;
        }
        .rank-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 40px; font-weight: bold; color: var(--silver-grey); }
        .rank-item.top3 .rank-num { color: var(--gold); font-size: 1.2rem; }
        .rank-name { flex: 1; }
        .rank-val { color: var(--primary-color); font-family: monospace; }
        .rank-item.is-me {
            color: var(--success-green) !important;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.4);
            background: rgba(46, 204, 113, 0.1); border-radius: 8px;
        }

        /* --- æ¸¸æˆä¸»ç•Œé¢ --- */
        .screen { display: none; width: 100%; max-width: 1000px; padding: 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; align-items: center; }

        #level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; width: 100%; margin-top: 20px; }
        .level-card { background: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .card-thumb { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #1a1a2e; font-size: 2rem; position: relative; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        
        #board-container { padding: 10px; background: #1a1a2e; border-radius: 8px; position: relative; transition: transform 0.8s ease-in-out; }
        #puzzle-board { display: grid; gap: 0; position: relative; border: 1px solid rgba(255, 255, 255, 0.2); background: #000; overflow: hidden;}
        .piece { box-sizing: border-box; background-repeat: no-repeat; border: 0.5px solid rgba(255, 255, 255, 0.15); touch-action: none; transition: transform 0.05s; }
        
        /* æ‹¼åˆåçš„æ— ç¼æ•ˆæœ */
        .no-border-right { border-right-color: transparent !important; }
        .no-border-bottom { border-bottom-color: transparent !important; }
        .no-border-left { border-left-color: transparent !important; }
        .no-border-top { border-top-color: transparent !important; }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; background: #333; color: white; font-weight: bold; }
        #rank-btn { background: rgba(241, 196, 15, 0.15); color: var(--gold); border: 1px solid var(--gold); }
        
        .victory-zoom { transform: scale(1.1); z-index: 100; }
        #victory-img { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>

    <div id="preview-overlay" class="overlay">
        <h2 style="color: var(--primary-color);">å…³å¡æˆå°±</h2>
        <img id="preview-img" style="max-width:80%; border-radius:8px;" src="">
        <div style="display: flex; gap: 20px; margin-top: 30px;">
            <button class="btn" onclick="closePreview()">è¿”å›èœå•</button>
            <button class="btn" style="background:var(--primary-color)" id="replay-btn">å†æ¬¡æŒ‘æˆ˜</button>
        </div>
    </div>

    <div id="auth-modal" class="overlay">
        <div class="modal-content">
            <h2>æ¬¢è¿æ¥åˆ°æ‹¼å›¾å¤§å¸ˆ</h2>
            <p style="opacity: 0.6; font-size: 0.8rem;">è®¾ç½®æ˜µç§°ä»¥å¼€å¯å…¨çƒæ’è¡Œæ¦œ</p>
            <input type="text" id="nickname-input" placeholder="è¾“å…¥æ˜µç§°..." maxlength="8">
            <button class="btn" style="width: 100%; background: var(--primary-color);" onclick="registerUser()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <div id="rank-modal" class="overlay">
        <h2 style="color:var(--gold);">ğŸ† å…¨çƒè‹±é›„æ¦œ</h2>
        <div class="rank-container" id="rank-list"></div>
        <button class="btn" style="margin-top: 20px; width: 100px;" onclick="closeRank()">è¿”å›</button>
    </div>

    <div id="user-bar">
        <div class="user-info">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <div id="user-name" style="font-weight: bold; font-size: 0.85rem;">æ¸¸å®¢</div>
                <div id="user-stat" style="font-size: 0.7rem; opacity: 0.5;">è¿›åº¦: Lv.0</div>
            </div>
        </div>
        <button class="btn" id="rank-btn" onclick="openRank()">ğŸ† æ’è¡Œæ¦œ</button>
    </div>

    <div id="menu-screen" class="screen active">
        <h2 style="margin: 15px 0;">ğŸ§© æ‹¼å›¾å¤§æœ¬è¥</h2>
        <div id="level-grid"></div>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button class="btn" onclick="showMenu()">â† èœå•</button>
            <h3 id="game-title" style="margin:0;">Level</h3>
            <div id="diff-label" style="opacity: 0.5; font-size: 0.8rem;">3x3</div>
        </div>
        <div id="board-container">
            <div id="puzzle-board"></div>
            <img id="victory-img" src="">
        </div>
    </div>

    <script>
        // --- 1. Supabase åˆå§‹åŒ– ---
        const SB_URL = 'https://afdnvaysvwdmbnxklogt.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE';
        
        let _db = null;
        try {
            if (typeof supabase !== 'undefined') {
                _db = supabase.createClient(SB_URL, SB_KEY);
            }
        } catch(e) { console.error("Supabase Init Failed", e); }

        // --- 2. æ ¸å¿ƒçŠ¶æ€ ---
        const FORMATS = ['.jpg', '.png', '.webp'];
        let levelData = [];
        let completedLevels = JSON.parse(localStorage.getItem('puz_save_v45') || '[]');
        let currentLevelId = 1, currentImgUrl = '', rows, cols, pW, pH, pieces = [], isVictory = false;

        // --- 3. æ•°æ®æœåŠ¡ ---
        const DataService = {
            async syncProgress(nick, level) {
                if(!_db) return;
                const uid = localStorage.getItem('puz_uid_v45');
                if(!uid) return;
                try {
                    await _db.from('rankings').upsert({ id: uid, nickname: nick, max_level: level });
                } catch(e) { console.error("Sync Error", e); }
            },
            async fetchRanks() {
                if(!_db) return [];
                try {
                    const { data } = await _db.from('rankings').select('*').order('max_level', {ascending: false}).limit(50);
                    return data || [];
                } catch(e) { return []; }
            }
        };

        // --- 4. åˆå§‹åŒ– ---
        async function init() {
            const nick = localStorage.getItem('puz_nick_v45');
            if (!nick) {
                document.getElementById('auth-modal').style.display = 'flex';
            } else {
                updateUserUI(nick);
                await discoverLevels();
            }
        }

        async function registerUser() {
            const input = document.getElementById('nickname-input');
            const nick = input.value.trim() || "ç©å®¶" + Math.floor(Math.random()*1000);
            const uid = 'U' + Date.now() + Math.floor(Math.random()*1000);
            localStorage.setItem('puz_nick_v45', nick);
            localStorage.setItem('puz_uid_v45', uid);
            document.getElementById('auth-modal').style.display = 'none';
            updateUserUI(nick);
            await DataService.syncProgress(nick, completedLevels.length);
            await discoverLevels();
        }

        function updateUserUI(nick) {
            document.getElementById('user-name').innerText = nick;
            document.getElementById('user-initial').innerText = nick[0].toUpperCase();
            document.getElementById('user-stat').innerText = `è¿›åº¦: Lv.${completedLevels.length}`;
        }

        // --- 5. èœå•é€»è¾‘ (é—®é¢˜1ä¿®å¤ï¼šåŠ è½½è¿›åº¦+5) ---
        async function discoverLevels() {
            const currentMax = completedLevels.length;
            const targetLoad = currentMax + 5; // å§‹ç»ˆæ¢æµ‹åˆ°å½“å‰ç­‰çº§+5
            
            levelData = [];
            for (let i = 1; i <= targetLoad; i++) {
                let foundUrl = null;
                for (const ext of FORMATS) {
                    const url = `${i}${ext}`;
                    const exists = await new Promise(r => {
                        const img = new Image(); 
                        img.onload = () => r(true); 
                        img.onerror = () => r(false); 
                        img.src = url;
                    });
                    if (exists) { foundUrl = url; break; }
                }
                if (foundUrl) {
                    levelData.push({ id: i, url: foundUrl });
                } else if (i > currentMax + 1) {
                    // å¦‚æœè¶…è¿‡äº†å½“å‰å¯ç©ç­‰çº§ä¸”æ²¡æ‰¾åˆ°å›¾ï¼Œæ‰åœæ­¢
                    break;
                }
            }
            renderMenu();
        }

        function renderMenu() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            levelData.forEach(lv => {
                const isDone = completedLevels.includes(lv.id);
                const isUnlocked = lv.id === 1 || completedLevels.includes(lv.id - 1);
                
                const card = document.createElement('div');
                card.className = `level-card ${!isUnlocked ? 'locked' : ''}`;
                if(!isUnlocked) card.style.opacity = '0.3';

                card.innerHTML = `
                    <div class="card-thumb">
                        ${isDone ? `<img src="${lv.url}">` : `<span>${lv.id}</span>`}
                    </div>
                    <div style="padding:8px;text-align:center;font-size:0.7rem;opacity:0.6">
                        ${isDone ? 'âœ… å·²è¾¾æˆ' : (isUnlocked ? 'ğŸ”¥ æŒ‘æˆ˜ä¸­' : 'ğŸ”’ æœªè§£é”')}
                    </div>
                `;
                if(isDone) card.onclick = () => showPreview(lv.url, lv.id);
                else if(isUnlocked) card.onclick = () => startLevel(lv.id);
                grid.appendChild(card);
            });
        }

        // --- 6. æ ¸å¿ƒæ¸¸æˆé€»è¾‘ (é—®é¢˜2ä¿®å¤ï¼šèåˆæ‹–åŠ¨) ---
        function startLevel(id) {
            isVictory = false; currentLevelId = id;
            const lv = levelData.find(l => l.id === id);
            if(!lv) return showMenu();
            currentImgUrl = lv.url;
            
            const img = new Image();
            img.src = currentImgUrl;
            img.onload = () => {
                const ratio = img.naturalWidth / img.naturalHeight;
                cols = 3 + Math.floor((id - 1) / 5);
                rows = Math.round(cols / ratio);
                
                const winW = Math.min(window.innerWidth - 40, 500);
                pW = Math.floor(winW / cols);
                pH = Math.floor((winW / ratio) / rows);

                document.getElementById('victory-img').src = currentImgUrl;
                document.getElementById('victory-img').style.opacity = '0';
                document.getElementById('board-container').classList.remove('victory-zoom');
                
                initBoard();
                document.getElementById('menu-screen').classList.remove('active');
                document.getElementById('game-screen').classList.add('active');
                document.getElementById('game-title').innerText = `Level ${id}`;
                document.getElementById('diff-label').innerText = `${cols} x ${rows}`;
                document.body.style.overflow = 'hidden';
            };
        }

        function initBoard() {
            pieces = [];
            for (let i = 0; i < rows * cols; i++) {
                pieces.push({ id: i, cur: i, bx: (i % cols) * pW, by: Math.floor(i / cols) * pH });
            }
            let pool = [...Array(rows * cols).keys()].sort(() => Math.random() - 0.5);
            pieces.forEach((p, i) => p.cur = pool[i]);
            renderPieces();
        }

        function renderPieces() {
            const board = document.getElementById('puzzle-board');
            board.innerHTML = '';
            board.style.width = `${pW * cols}px`;
            board.style.height = `${pH * rows}px`;
            board.style.gridTemplateColumns = `repeat(${cols}, ${pW}px)`;

            const gridMap = {}; pieces.forEach(p => gridMap[p.cur] = p);

            pieces.sort((a,b) => a.cur - b.cur).forEach(p => {
                const div = document.createElement('div');
                div.className = 'piece';
                div.dataset.id = p.id; // é‡è¦ï¼šç»‘å®šåŸå§‹IDç”¨äºæŸ¥æ‰¾
                div.style.width = `${pW}px`; div.style.height = `${pH}px`;
                div.style.backgroundImage = `url(${currentImgUrl})`;
                div.style.backgroundPosition = `-${p.bx}px -${p.by}px`;
                div.style.backgroundSize = `${pW * cols}px ${pH * rows}px`;

                // ç¼éš™ä¸èåˆé€»è¾‘
                const pos = p.cur, r = Math.floor(pos / cols), c = pos % cols;
                if (c < cols - 1 && gridMap[pos+1]?.id === p.id+1 && Math.floor(p.id/cols) === Math.floor((p.id+1)/cols)) div.classList.add('no-border-right');
                if (c > 0 && gridMap[pos-1]?.id === p.id-1 && Math.floor(p.id/cols) === Math.floor((p.id-1)/cols)) div.classList.add('no-border-left');
                if (r < rows - 1 && gridMap[pos+cols]?.id === p.id+cols) div.classList.add('no-border-bottom');
                if (r > 0 && gridMap[pos-cols]?.id === p.id-cols) div.classList.add('no-border-top');

                div.onpointerdown = e => handleDrag(e, p.id);
                board.appendChild(div);
            });
        }

        function handleDrag(e, id) {
            if(isVictory) return;
            const group = getGroup(id);
            const startX = e.clientX, startY = e.clientY;
            
            // è·å–æ‰€æœ‰å±äºè¯¥ç»„çš„ DOM å…ƒç´ 
            const groupEls = [];
            group.forEach(gid => {
                const el = document.querySelector(`.piece[data-id="${gid}"]`);
                if(el) {
                    el.style.zIndex = "100";
                    groupEls.push(el);
                }
            });

            window.onpointermove = (ev) => {
                const dx = ev.clientX - startX, dy = ev.clientY - startY;
                groupEls.forEach(el => {
                    el.style.transform = `translate(${dx}px, ${dy}px)`;
                });
            };

            window.onpointerup = (ev) => {
                window.onpointermove = null; window.onpointerup = null;
                const dx = ev.clientX - startX, dy = ev.clientY - startY;
                let dC = Math.round(dx / pW), dR = Math.round(dy / pH);
                
                if (dC !== 0 || dR !== 0) {
                    let illegal = false; const plan = [];
                    for (let gid of group) {
                        const p = pieces.find(x => x.id === gid);
                        const nr = Math.floor(p.cur / cols) + dR, nc = (p.cur % cols) + dC;
                        if (nr < 0 || nr >= rows || nc < 0 || nc >= cols) { illegal = true; break; }
                        plan.push({ p, from: p.cur, to: nr * cols + nc });
                    }
                    if (!illegal) {
                        const targets = plan.map(m => m.to);
                        // æ‰¾å‡ºéæœ¬ç»„ä½†è¢«å ä½çš„å—å®³è€…
                        const victims = pieces.filter(x => targets.includes(x.cur) && !group.includes(x.id));
                        const vacant = plan.map(m => m.from).filter(v => !targets.includes(v));
                        plan.forEach(m => m.p.cur = m.to);
                        victims.forEach((v, i) => v.cur = vacant[i]);
                    }
                }
                renderPieces();
                checkWin();
            };
        }

        function getGroup(startId) {
            const group = new Set([startId]), queue = [startId];
            while (queue.length > 0) {
                const id = queue.shift(), p = pieces.find(x => x.id === id);
                const r = Math.floor(p.cur / cols), c = p.cur % cols;
                const adjs = [
                    {dr:0,dc:1,cond:n=>n.id===p.id+1 && Math.floor(p.id/cols)===Math.floor(n.id/cols)},
                    {dr:0,dc:-1,cond:n=>n.id===p.id-1 && Math.floor(p.id/cols)===Math.floor(n.id/cols)},
                    {dr:1,dc:0,cond:n=>n.id===p.id+cols},
                    {dr:-1,dc:0,cond:n=>n.id===p.id-cols}
                ];
                adjs.forEach(a => {
                    const nr = r+a.dr, nc = c+a.dc;
                    if (nr>=0 && nr<rows && nc>=0 && nc<cols) {
                        const neighbor = pieces.find(x => x.cur === nr*cols+nc);
                        if (neighbor && !group.has(neighbor.id) && a.cond(neighbor)) {
                            group.add(neighbor.id); queue.push(neighbor.id);
                        }
                    }
                });
            }
            return Array.from(group);
        }

        // é—®é¢˜3ä¿®å¤ï¼šæ’è¡Œæ¦œæ•°æ®åŒæ­¥
        async function checkWin() {
            if (pieces.every(p => p.id === p.cur)) {
                isVictory = true;
                document.getElementById('victory-img').style.opacity = '1';
                document.getElementById('board-container').classList.add('victory-zoom');
                
                if (!completedLevels.includes(currentLevelId)) {
                    completedLevels.push(currentLevelId);
                    localStorage.setItem('puz_save_v45', JSON.stringify(completedLevels));
                    // ç«‹å³åŒæ­¥è¿›åº¦
                    const nick = localStorage.getItem('puz_nick_v45');
                    await DataService.syncProgress(nick, completedLevels.length);
                }
                
                updateUserUI(localStorage.getItem('puz_nick_v45'));
                // èƒœåˆ©åé‡æ–°æ¢æµ‹æ–°å…³å¡
                await discoverLevels();

                setTimeout(() => {
                    showMenu();
                }, 2000);
            }
        }

        // --- 7. UI å‡½æ•° ---
        function showMenu() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            document.body.style.overflow = 'auto';
            renderMenu();
        }

        function showPreview(url, id) {
            document.getElementById('preview-img').src = url;
            document.getElementById('preview-overlay').style.display = 'flex';
            document.getElementById('replay-btn').onclick = () => { closePreview(); startLevel(id); };
        }
        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }

        async function openRank() {
            const list = document.getElementById('rank-list');
            list.innerHTML = '<p style="text-align:center; opacity:0.5;">åŒæ­¥ä¸­...</p>';
            document.getElementById('rank-modal').style.display = 'flex';
            
            const ranks = await DataService.fetchRanks();
            const myUid = localStorage.getItem('puz_uid_v45');
            list.innerHTML = ranks.map((r, i) => `
                <div class="rank-item ${i < 3 ? 'top3' : ''} ${r.id === myUid ? 'is-me' : ''}">
                    <div class="rank-num">${i + 1}</div>
                    <div class="rank-name">${r.nickname || 'æ— å'} ${r.id === myUid ? '(æˆ‘)' : ''}</div>
                    <div class="rank-val">Lv.${r.max_level}</div>
                </div>
            `).join('') || '<p style="text-align:center">æš‚æ— æ•°æ®</p>';
        }
        function closeRank() { document.getElementById('rank-modal').style.display = 'none'; }

        window.onload = init;
    </script>
</body>
</html>