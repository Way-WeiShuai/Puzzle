<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>拼图大师 v4.2 · Supabase 稳定版</title>

<!-- Supabase SDK（只加载一次） -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://afdnvaysvwdmbnxklogt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
</script>

<style>
/* ===== 原 CSS，未改动任何表现逻辑 ===== */
:root {
    --primary-color: #4a90e2;
    --bg-dark: #0f0f1e;
    --card-bg: rgba(255, 255, 255, 0.05);
    --silver-grey: #bdc3c7;
    --gold: #f1c40f;
    --success-green: #2ecc71;
}
body {
    font-family: 'PingFang SC', sans-serif;
    background-color: var(--bg-dark);
    color: white;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
}
/* ……中间 CSS 与你原文件完全一致，省略展示…… */
</style>
</head>

<body>

<!-- ===== 原 HTML 结构（未改动） ===== -->
<!-- auth-modal / rank-modal / user-bar / menu-screen / game-screen -->
<!-- （此处省略 UI 结构，与你现有文件一致，不影响逻辑） -->

<script>
/* =====================================================
   数据 & Supabase 接入层（只替换这里）
   ===================================================== */

const DataService = {
    async getUser() {
        const id = localStorage.getItem('puz_user_id');
        const nick = localStorage.getItem('puz_nickname');
        return id ? { id, nick } : null;
    },

    async saveUser(nick) {
        const { data, error } = await supabaseClient
            .from('players')
            .insert([{ nickname: nick, max_level: 0 }])
            .select()
            .single();

        if (error) {
            console.error(error);
            alert('注册失败，请刷新页面重试');
            return null;
        }

        localStorage.setItem('puz_user_id', data.id);
        localStorage.setItem('puz_nickname', data.nickname);
        return { id: data.id, nick: data.nickname };
    },

    async getRankings() {
        const { data, error } = await supabaseClient
            .from('players')
            .select('id, nickname, max_level')
            .order('max_level', { ascending: false })
            .limit(1000);

        if (error) {
            console.error(error);
            return [];
        }

        const myId = localStorage.getItem('puz_user_id');
        return data.map(r => ({
            nick: r.nickname,
            level: r.max_level,
            isMe: r.id === myId
        }));
    }
};

/* =====================================================
   云端进度同步（独立函数，不侵入逻辑）
   ===================================================== */
async function syncProgressToCloud() {
    const userId = localStorage.getItem('puz_user_id');
    if (!userId) return;

    const comp = JSON.parse(localStorage.getItem('puz_comp_v31') || '[]');
    const maxLevel = comp.length ? Math.max(...comp) : 0;

    await supabaseClient
        .from('players')
        .update({ max_level: maxLevel })
        .eq('id', userId);
}

/* =====================================================
   下面是你原来的游戏逻辑（仅改一行）
   ===================================================== */

/* ……中间所有原逻辑代码保持不变…… */

function checkWin() {
    if (pieces.every(p => p.id === p.currentPos)) {
        isVictoryProcessing = true;

        if (!completedLevels.includes(currentLevelId)) {
            completedLevels.push(currentLevelId);
            localStorage.setItem(
              'puz_comp_v31',
              JSON.stringify(completedLevels)
            );
        }

        updateUserUI(localStorage.getItem('puz_nickname'));

        // ✅ 唯一新增：同步到 Supabase
        syncProgressToCloud();

        document
          .getElementById('board-container')
          .classList.add('victory-zoom');

        setTimeout(() => {
            discoverLevels();
            startLevel(currentLevelId + 1);
        }, 1500);
    }
}

/* init() 等其余逻辑保持原样 */

</script>
</body>
</html>
