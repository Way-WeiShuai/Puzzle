<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾å¤§å¸ˆ - v4.6 äº‘ç«¯ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-dark: #0f0f1e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --gold: #f1c40f;
            --success-green: #2ecc71;
        }

        body {
            font-family: 'PingFang SC', sans-serif;
            background-color: var(--bg-dark); color: white; margin: 0; 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            overflow-x: hidden; -webkit-overflow-scrolling: touch;
        }

        /* --- é¡¶éƒ¨æ  --- */
        #user-bar {
            width: 100%; max-width: 1000px; padding: 15px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .user-avatar { width: 32px; height: 32px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* --- å¼¹çª—ä¸é®ç½© --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); padding: 20px; box-sizing: border-box;
        }

        #auth-modal .modal-content {
            background: #1a1a2e; padding: 30px; border-radius: 12px; border: 1px solid var(--primary-color);
            width: 90%; max-width: 350px; text-align: center;
        }
        #auth-modal input {
            width: 100%; padding: 12px; margin: 20px 0; border-radius: 6px; border: 1px solid #333;
            background: #0f0f1e; color: white; box-sizing: border-box; text-align: center;
        }

        /* --- æ’è¡Œæ¦œ --- */
        #rank-modal .rank-container { width: 100%; max-width: 500px; height: 60vh; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; }
        .rank-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-item.is-me { color: var(--success-green); border: 1px solid rgba(46, 204, 113, 0.4); background: rgba(46, 204, 113, 0.1); border-radius: 10px; }

        /* --- æ¸¸æˆä¸»ç•Œé¢ --- */
        .screen { display: none; width: 100%; max-width: 1000px; padding: 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; align-items: center; }

        #level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; width: 100%; }
        .level-card { background: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .card-thumb { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #1a1a2e; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        
        #board-container { padding: 10px; background: #1a1a2e; border-radius: 8px; position: relative; }
        #puzzle-board { display: grid; position: relative; background: #000; overflow: hidden; }
        .piece { box-sizing: border-box; background-repeat: no-repeat; border: 1px solid rgba(255, 255, 255, 0.1); touch-action: none; position: relative; }
        
        #victory-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; opacity: 0; z-index: 50; pointer-events: none; transition: opacity 0.5s; 
        }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; background: #333; color: white; font-weight: bold; }
        #rank-btn { background: rgba(241, 196, 15, 0.15); color: var(--gold); border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <div id="auth-modal" class="overlay">
        <div class="modal-content">
            <h2>ğŸŒ å¼€å¯åŒæ­¥ä¹‹æ—…</h2>
            <p style="opacity: 0.6; font-size: 0.8rem;">è®¾ç½®æ˜µç§°ä»¥ä¿å­˜äº‘ç«¯è¿›åº¦</p>
            <input type="text" id="nickname-input" placeholder="è¾“å…¥æ˜µç§°..." maxlength="8">
            <button class="btn" style="width: 100%; background: var(--primary-color);" onclick="registerUser()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <div id="rank-modal" class="overlay">
        <h2 style="color:var(--gold)">ğŸ† å…¨çƒæ¦œå•</h2>
        <div class="rank-container" id="rank-list"></div>
        <button class="btn" style="margin-top: 20px; width: 180px;" onclick="closeRank()">è¿”å›</button>
    </div>

    <div id="user-bar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="user-avatar" id="user-initial">?</div>
            <div>
                <div id="user-name" style="font-weight: bold; font-size: 0.9rem;">æ¸¸å®¢</div>
                <div id="user-stat" style="font-size: 0.7rem; opacity: 0.5;">Lv.0</div>
            </div>
        </div>
        <button class="btn" id="rank-btn" onclick="openRank()">ğŸ† æ’è¡Œæ¦œ</button>
    </div>

    <div id="menu-screen" class="screen active">
        <h1 style="margin: 20px 0;">ğŸ§© æ‹¼å›¾å¤§å¸ˆ <span style="font-size: 0.8rem; opacity: 0.3;">v4.6</span></h1>
        <div id="level-grid"></div>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="btn" onclick="showMenu()">â† èœå•</button>
            <h2 id="game-title" style="margin:0;">Level</h2>
            <div id="diff-label" style="font-size: 0.8rem; opacity: 0.6;">éš¾åº¦: 3x3</div>
        </div>
        <div id="board-container">
            <div id="puzzle-board">
                <img id="victory-overlay" src="">
            </div>
        </div>
    </div>

    <script>
        // --- è¯·æ›¿æ¢ä¸ºæ‚¨åœ¨ Supabase é¡¹ç›®ä¸­è·å–çš„çœŸå®ä¿¡æ¯ ---
        const SUPABASE_URL = 'https://afdnvaysvwdmbnxklogt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmZG52YXlzdndkbWJueGtsb2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQyNzMsImV4cCI6MjA4NTI1MDI3M30.KI1Mi3cNBwy1A0-Fx9V9DIITzgExyhQgLRGvEwDWFsE';
        
        // å…³é”®ä¿®å¤ï¼šæ”¹åä¸º _db é¿å…ä¸åº“åå†²çª
        const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let levelData = [], completedLevels = JSON.parse(localStorage.getItem('puz_comp_v31') || '[]');
        let currentImgUrl = '', currentLevelId = 1, rows, cols, pWidth, pHeight;
        let pieces = [], isVictory = false;

        const DataService = {
            async getUser() {
                return localStorage.getItem('puz_user_id') ? { nick: localStorage.getItem('puz_nickname') } : null;
            },
            async saveUser(nick) {
                const { data, error } = await _db.from('rankings').insert([{ nickname: nick, max_level: 0 }]).select();
                if (error) return { id: 'temp_'+Date.now(), nickname: nick };
                localStorage.setItem('puz_user_id', data[0].id);
                localStorage.setItem('puz_nickname', data[0].nickname);
                return data[0];
            },
            async submitScore(level) {
                const id = localStorage.getItem('puz_user_id');
                if (!id || id.startsWith('temp_')) return;
                await _db.from('rankings').update({ max_level: level, updated_at: new Date() }).eq('id', id);
            },
            async getRankings() {
                const { data } = await _db.from('rankings').select('*').order('max_level', { ascending: false }).limit(20);
                // å®¹é”™ï¼šå¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œæ˜¾ç¤ºæœ¬åœ°è¿›åº¦
                if (!data || data.length === 0) {
                    return [{ nickname: localStorage.getItem('puz_nickname') || "æˆ‘", max_level: completedLevels.length, isMe: true }];
                }
                const myId = localStorage.getItem('puz_user_id');
                return data.map(r => ({ ...r, isMe: r.id === myId }));
            }
        };

        async function init() {
            const user = await DataService.getUser();
            if (!user) document.getElementById('auth-modal').style.display = 'flex';
            else { updateUserUI(user.nick); discoverLevels(); }
        }

        async function registerUser() {
            const input = document.getElementById('nickname-input');
            const user = await DataService.saveUser(input.value.trim() || "ç©å®¶");
            document.getElementById('auth-modal').style.display = 'none';
            updateUserUI(user.nickname); discoverLevels();
        }

        function updateUserUI(nick) {
            document.getElementById('user-name').innerText = nick;
            document.getElementById('user-initial').innerText = nick[0].toUpperCase();
            const maxL = completedLevels.length > 0 ? Math.max(...completedLevels) : 0;
            document.getElementById('user-stat').innerText = `Lv.${maxL}`;
        }

        async function openRank() {
            const list = document.getElementById('rank-list');
            list.innerHTML = '<p style="text-align:center">æ­£åœ¨åŠ è½½äº‘ç«¯è‹±é›„æ¦œ...</p>';
            document.getElementById('rank-modal').style.display = 'flex';
            const rankings = await DataService.getRankings();
            list.innerHTML = '';
            rankings.forEach((r, i) => {
                const item = document.createElement('div');
                item.className = `rank-item ${r.isMe ? 'is-me' : ''}`;
                item.innerHTML = `<div style="width:30px">${i+1}</div><div style="flex:1">${r.nickname}</div><div>Lv.${r.max_level}</div>`;
                list.appendChild(item);
            });
        }

        function closeRank() { document.getElementById('rank-modal').style.display = 'none'; }

        async function discoverLevels() {
            const currentMax = completedLevels.length > 0 ? Math.max(...completedLevels) : 0;
            for(let i=1; i<=currentMax+5; i++) {
                if(!levelData.find(l=>l.id===i)) {
                    const url = await findImage(i);
                    if(url) levelData.push({id:i, url});
                }
            }
            renderMenu();
        }

        async function findImage(id) {
            for (let ext of ['.jpg', '.png', '.webp']) {
                const url = `${id}${ext}`;
                const ok = await new Promise(r => { const img = new Image(); img.onload=()=>r(true); img.onerror=()=>r(false); img.src=url; });
                if(ok) return url;
            }
            return null;
        }

        function renderMenu() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            levelData.forEach(l => {
                const isDone = completedLevels.includes(l.id);
                const isLock = l.id > 1 && !completedLevels.includes(l.id-1);
                const card = document.createElement('div');
                card.className = 'level-card';
                if(isLock) card.style.opacity = '0.3';
                card.innerHTML = `<div class="card-thumb">${isDone?`<img src="${l.url}">`:l.id}</div><div style="text-align:center;font-size:0.6rem;padding:5px">${isDone?'å·²è¾¾æˆ':'å¾…æŒ‘æˆ˜'}</div>`;
                if(!isLock) card.onclick = () => startLevel(l.id);
                grid.appendChild(card);
            });
        }

        function startLevel(id) {
            isVictory = false; currentLevelId = id;
            const l = levelData.find(x=>x.id===id);
            currentImgUrl = l.url;
            
            // å…³é”®ä¿®å¤ï¼šç¡®ä¿ ID å­˜åœ¨
            const overlay = document.getElementById('victory-overlay');
            overlay.src = l.url; overlay.style.opacity = '0';

            const img = new Image(); img.src = l.url;
            img.onload = () => {
                rows = 3; cols = 3;
                pWidth = Math.min(window.innerWidth*0.8, 400)/cols;
                pHeight = (pWidth*cols * (img.height/img.width))/rows;
                initBoard();
                document.getElementById('menu-screen').classList.remove('active');
                document.getElementById('game-screen').classList.add('active');
                document.getElementById('game-title').innerText = `Level ${id}`;
            };
        }

        function initBoard() {
            pieces = [];
            for(let i=0; i<rows*cols; i++) pieces.push({id:i, currentPos:i, bgX:(i%cols)*pWidth, bgY:Math.floor(i/cols)*pHeight});
            let pool = [...Array(rows*cols).keys()].sort(()=>Math.random()-0.5);
            pieces.forEach((p,i)=>p.currentPos=pool[i]);
            renderPieces();
        }

        function renderPieces() {
            const board = document.getElementById('puzzle-board');
            const overlay = document.getElementById('victory-overlay');
            board.innerHTML = ''; board.appendChild(overlay);
            board.style.width = `${pWidth*cols}px`;
            board.style.gridTemplateColumns = `repeat(${cols}, ${pWidth}px)`;

            pieces.sort((a,b)=>a.currentPos-b.currentPos).forEach(p => {
                const div = document.createElement('div');
                div.className = 'piece'; div.style.width=`${pWidth}px`; div.style.height=`${pHeight}px`;
                div.style.backgroundImage=`url(${currentImgUrl})`;
                div.style.backgroundPosition=`-${p.bgX}px -${p.bgY}px`;
                div.style.backgroundSize=`${pWidth*cols}px ${pHeight*rows}px`;
                div.onpointerdown = e => handleDrag(e, p.id);
                board.appendChild(div);
            });
        }

        function handleDrag(e, id) {
            if(isVictory) return;
            const startX = e.clientX, startY = e.clientY;
            const p = pieces.find(x=>x.id===id);
            const originalPos = p.currentPos;
            
            window.onpointermove = ev => {
                const dx = ev.clientX - startX, dy = ev.clientY - startY;
                const el = document.querySelector(`[style*="background-position: -${p.bgX}px"]`);
                if(el) el.style.transform = `translate(${dx}px, ${dy}px)`;
                if(el) el.style.zIndex = "100";
            };

            window.onpointerup = ev => {
                window.onpointermove = null;
                const dx = ev.clientX - startX, dy = ev.clientY - startY;
                const dC = Math.round(dx/pWidth), dR = Math.round(dy/pHeight);
                const targetPos = originalPos + dR*cols + dC;
                
                if(targetPos >= 0 && targetPos < rows*cols && targetPos !== originalPos) {
                    const victim = pieces.find(x=>x.currentPos === targetPos);
                    if(victim) { p.currentPos = targetPos; victim.currentPos = originalPos; }
                }
                renderPieces(); checkWin();
            };
        }

        async function checkWin() {
            if (pieces.every(p => p.id === p.currentPos)) {
                isVictory = true;
                document.getElementById('victory-overlay').style.opacity = '1';
                if(!completedLevels.includes(currentLevelId)) {
                    completedLevels.push(currentLevelId);
                    localStorage.setItem('puz_comp_v31', JSON.stringify(completedLevels));
                    await DataService.submitScore(Math.max(...completedLevels));
                }
                setTimeout(() => { alert('å…³å¡å®Œæˆï¼'); showMenu(); }, 600);
            }
        }

        function showMenu() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
            updateUserUI(localStorage.getItem('puz_nickname'));
            discoverLevels();
        }

        init();
    </script>
</body>
</html>